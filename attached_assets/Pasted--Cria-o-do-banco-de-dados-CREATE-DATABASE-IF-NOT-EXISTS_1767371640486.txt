-- Criação do banco de dados
CREATE DATABASE IF NOT EXISTS simple_contract CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE simple_contract;

-- Tabela de entidades (clientes e fornecedores)
CREATE TABLE entidades (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    tipo_pessoa ENUM('fisica', 'juridica') NOT NULL,
    cpf_cnpj VARCHAR(20) UNIQUE,
    email VARCHAR(255),
    telefone VARCHAR(20),
    email_cobranca VARCHAR(255),
    telefone_cobranca VARCHAR(20),
    endereco TEXT,
    numero VARCHAR(20),
    complemento VARCHAR(100),
    bairro VARCHAR(100),
    cidade VARCHAR(100),
    estado VARCHAR(2),
    cep VARCHAR(10),
    eh_cliente BOOLEAN DEFAULT FALSE,
    eh_fornecedor BOOLEAN DEFAULT FALSE,
    observacoes TEXT,
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_atualizacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Tabela de serviços
CREATE TABLE servicos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    descricao TEXT,
    categoria VARCHAR(100),
    ativo BOOLEAN DEFAULT TRUE,
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_atualizacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Tabela de planos de serviços
CREATE TABLE planos_servicos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    servico_id INT NOT NULL,
    nome VARCHAR(255) NOT NULL,
    escopo TEXT,
    diretrizes TEXT,
    valor DECIMAL(10,2),
    periodicidade ENUM('unico', 'mensal', 'trimestral', 'semestral', 'anual') DEFAULT 'unico',
    ativo BOOLEAN DEFAULT TRUE,
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_atualizacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (servico_id) REFERENCES servicos(id) ON DELETE CASCADE
);

-- Tabela de contratos
CREATE TABLE contratos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    numero_contrato VARCHAR(50) UNIQUE NOT NULL,
    cliente_id INT NOT NULL,
    fornecedor_id INT,
    titulo VARCHAR(255) NOT NULL,
    descricao TEXT,
    valor_total DECIMAL(10,2),
    data_inicio DATE,
    data_fim DATE,
    status ENUM('rascunho', 'enviado_assinatura', 'assinado', 'cancelado', 'vencido') DEFAULT 'rascunho',
    url_assinatura VARCHAR(500),
    documento_assinado VARCHAR(500),
    observacoes TEXT,
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_atualizacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (cliente_id) REFERENCES entidades(id),
    FOREIGN KEY (fornecedor_id) REFERENCES entidades(id)
);

-- Tabela de itens do contrato (serviços/planos incluídos)
CREATE TABLE contrato_itens (
    id INT AUTO_INCREMENT PRIMARY KEY,
    contrato_id INT NOT NULL,
    plano_servico_id INT NOT NULL,
    quantidade INT DEFAULT 1,
    valor_unitario DECIMAL(10,2),
    valor_total DECIMAL(10,2),
    observacoes TEXT,
    FOREIGN KEY (contrato_id) REFERENCES contratos(id) ON DELETE CASCADE,
    FOREIGN KEY (plano_servico_id) REFERENCES planos_servicos(id)
);

-- Tabela de aditivos contratuais
CREATE TABLE aditivos_contratuais (
    id INT AUTO_INCREMENT PRIMARY KEY,
    contrato_id INT NOT NULL,
    numero_aditivo VARCHAR(50) NOT NULL,
    tipo_aditivo ENUM('inclusao_servico', 'alteracao_valor', 'alteracao_prazo', 'alteracao_escopo', 'outros') NOT NULL,
    descricao TEXT NOT NULL,
    valor_anterior DECIMAL(10,2),
    valor_novo DECIMAL(10,2),
    data_inicio_vigencia DATE,
    status ENUM('rascunho', 'enviado_assinatura', 'assinado', 'cancelado') DEFAULT 'rascunho',
    url_assinatura VARCHAR(500),
    documento_assinado VARCHAR(500),
    observacoes TEXT,
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_atualizacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (contrato_id) REFERENCES contratos(id) ON DELETE CASCADE
);

-- Tabela de itens dos aditivos (novos serviços incluídos)
CREATE TABLE aditivo_itens (
    id INT AUTO_INCREMENT PRIMARY KEY,
    aditivo_id INT NOT NULL,
    plano_servico_id INT NOT NULL,
    quantidade INT DEFAULT 1,
    valor_unitario DECIMAL(10,2),
    valor_total DECIMAL(10,2),
    observacoes TEXT,
    FOREIGN KEY (aditivo_id) REFERENCES aditivos_contratuais(id) ON DELETE CASCADE,
    FOREIGN KEY (plano_servico_id) REFERENCES planos_servicos(id)
);

-- Tabela de configurações da empresa
CREATE TABLE configuracoes_empresa (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome_empresa VARCHAR(255) NOT NULL,
    cnpj VARCHAR(20),
    nome_socio VARCHAR(255),
    cpf_socio VARCHAR(14),
    endereco TEXT,
    telefone VARCHAR(20),
    email VARCHAR(255),
    site VARCHAR(255),
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_atualizacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Índices para melhor performance
CREATE INDEX idx_entidades_cpf_cnpj ON entidades(cpf_cnpj);
CREATE INDEX idx_entidades_tipo ON entidades(eh_cliente, eh_fornecedor);
CREATE INDEX idx_contratos_status ON contratos(status);
CREATE INDEX idx_contratos_cliente ON contratos(cliente_id);
CREATE INDEX idx_aditivos_contrato ON aditivos_contratuais(contrato_id);

-- Inserir alguns dados de exemplo
INSERT INTO entidades (nome, tipo_pessoa, cpf_cnpj, email, telefone, eh_cliente, eh_fornecedor) VALUES
('João Silva', 'fisica', '123.456.789-00', 'joao@email.com', '(11) 99999-9999', TRUE, FALSE),
('Empresa ABC Ltda', 'juridica', '12.345.678/0001-90', 'contato@empresaabc.com', '(11) 3333-3333', TRUE, TRUE),
('Maria Santos', 'fisica', '987.654.321-00', 'maria@email.com', '(11) 88888-8888', FALSE, TRUE);

INSERT INTO servicos (nome, descricao, categoria) VALUES
('Desenvolvimento Web', 'Criação de sites e sistemas web', 'Tecnologia'),
('Consultoria Empresarial', 'Consultoria em gestão e processos', 'Consultoria'),
('Marketing Digital', 'Serviços de marketing online', 'Marketing');

INSERT INTO planos_servicos (servico_id, nome, escopo, diretrizes, valor, periodicidade) VALUES
(1, 'Site Básico', 'Desenvolvimento de site institucional com até 5 páginas', 'Responsivo, SEO básico, formulário de contato', 2500.00, 'unico'),
(1, 'Sistema Completo', 'Desenvolvimento de sistema web completo', 'Backend, frontend, banco de dados, testes', 15000.00, 'unico'),
(2, 'Consultoria Mensal', 'Consultoria empresarial mensal', 'Reuniões quinzenais, relatórios mensais', 3000.00, 'mensal'),
(3, 'Gestão de Redes Sociais', 'Gerenciamento completo das redes sociais', 'Posts diários, stories, relatórios', 1500.00, 'mensal');

-- Tabela de usuários do sistema
CREATE TABLE usuarios (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    senha VARCHAR(255) NOT NULL,
    nivel_acesso ENUM('master', 'admin', 'usuario', 'visualizador') DEFAULT 'usuario',
    ativo BOOLEAN DEFAULT TRUE,
    ultimo_login TIMESTAMP NULL,
    tentativas_login INT DEFAULT 0,
    bloqueado_ate TIMESTAMP NULL,
    token_reset VARCHAR(255) NULL,
    token_reset_expira TIMESTAMP NULL,
    criado_por INT NULL,
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_atualizacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (criado_por) REFERENCES usuarios(id) ON DELETE SET NULL
);

-- Tabela de módulos do sistema
CREATE TABLE modulos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL UNIQUE,
    descricao VARCHAR(255),
    icone VARCHAR(50),
    url VARCHAR(255),
    ordem INT DEFAULT 0,
    ativo BOOLEAN DEFAULT TRUE,
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de permissões por usuário e módulo
CREATE TABLE permissoes_usuario (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT NOT NULL,
    modulo_id INT NOT NULL,
    pode_visualizar BOOLEAN DEFAULT FALSE,
    pode_editar BOOLEAN DEFAULT FALSE,
    pode_excluir BOOLEAN DEFAULT FALSE,
    pode_criar BOOLEAN DEFAULT FALSE,
    data_cadastro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_atualizacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE,
    FOREIGN KEY (modulo_id) REFERENCES modulos(id) ON DELETE CASCADE,
    UNIQUE KEY unique_usuario_modulo (usuario_id, modulo_id)
);

-- Tabela de auditoria/log de ações
CREATE TABLE auditoria (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT NULL,
    modulo VARCHAR(100),
    acao VARCHAR(100),
    tabela_afetada VARCHAR(100),
    registro_id INT NULL,
    dados_anteriores JSON NULL,
    dados_novos JSON NULL,
    ip_address VARCHAR(45),
    user_agent TEXT,
    data_acao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE SET NULL
);

-- Tabela de sessões de usuário
CREATE TABLE sessoes_usuario (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT NOT NULL,
    token_sessao VARCHAR(255) UNIQUE NOT NULL,
    ip_address VARCHAR(45),
    user_agent TEXT,
    data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    data_expiracao TIMESTAMP NOT NULL,
    ativo BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE
);

-- Adicionar campo usuario_id na tabela contratos para auditoria
ALTER TABLE contratos ADD COLUMN usuario_criacao INT NULL AFTER observacoes;
ALTER TABLE contratos ADD COLUMN usuario_atualizacao INT NULL AFTER usuario_criacao;
ALTER TABLE contratos ADD FOREIGN KEY (usuario_criacao) REFERENCES usuarios(id) ON DELETE SET NULL;
ALTER TABLE contratos ADD FOREIGN KEY (usuario_atualizacao) REFERENCES usuarios(id) ON DELETE SET NULL;

-- Índices para melhor performance nas novas tabelas
CREATE INDEX idx_usuarios_email ON usuarios(email);
CREATE INDEX idx_usuarios_nivel ON usuarios(nivel_acesso);
CREATE INDEX idx_permissoes_usuario ON permissoes_usuario(usuario_id);
CREATE INDEX idx_auditoria_usuario ON auditoria(usuario_id);
CREATE INDEX idx_auditoria_data ON auditoria(data_acao);
CREATE INDEX idx_sessoes_token ON sessoes_usuario(token_sessao);
CREATE INDEX idx_sessoes_usuario ON sessoes_usuario(usuario_id);

-- Inserir módulos padrão do sistema
INSERT INTO modulos (nome, descricao, icone, url, ordem) VALUES
('dashboard', 'Dashboard Principal', 'fas fa-tachometer-alt', 'pages/dashboard.php', 1),
('entidades', 'Gestão de Entidades', 'fas fa-users', 'pages/entidades.php', 2),
('servicos', 'Gestão de Serviços', 'fas fa-cogs', 'pages/servicos.php', 3),
('contratos', 'Gestão de Contratos', 'fas fa-file-contract', 'pages/contratos.php', 4),
('configuracoes', 'Configurações', 'fas fa-cog', 'pages/configuracoes.php', 5),
('usuarios', 'Gestão de Usuários', 'fas fa-user-cog', 'pages/usuarios.php', 6),
('auditoria', 'Auditoria do Sistema', 'fas fa-history', 'pages/auditoria.php', 7);

-- Inserir usuário master padrão (senha: admin123 - deve ser alterada no primeiro login)
INSERT INTO usuarios (nome, email, senha, nivel_acesso) VALUES
('Administrador Master', 'admin@admin.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'master');

-- Inserir permissões completas para o usuário master
INSERT INTO permissoes_usuario (usuario_id, modulo_id, pode_visualizar, pode_editar, pode_excluir, pode_criar)
SELECT 1, id, TRUE, TRUE, TRUE, TRUE FROM modulos;

-- Inserir configuração padrão da empresa
INSERT INTO configuracoes_empresa (nome_empresa, cnpj, endereco, telefone, email) VALUES
('Turbo Partners Ltda.', '42.100.292/0001-84', 'R. Maria de Lourdes García, 228 - Ilha de Santa Maria, Vitória - ES, 29053-310', '(27) 99796-9628', 'contato@turbopartners.com.br');

-- Trigger para registrar auditoria em contratos
DELIMITER //
CREATE TRIGGER tr_contratos_insert AFTER INSERT ON contratos
FOR EACH ROW
BEGIN
    INSERT INTO auditoria (usuario_id, modulo, acao, tabela_afetada, registro_id, dados_novos, ip_address)
    VALUES (NEW.usuario_criacao, 'contratos', 'INSERT', 'contratos', NEW.id, JSON_OBJECT(
        'numero_contrato', NEW.numero_contrato,
        'cliente_id', NEW.cliente_id,
        'titulo', NEW.titulo,
        'valor_total', NEW.valor_total,
        'status', NEW.status
    ), @user_ip);
END//

CREATE TRIGGER tr_contratos_update AFTER UPDATE ON contratos
FOR EACH ROW
BEGIN
    INSERT INTO auditoria (usuario_id, modulo, acao, tabela_afetada, registro_id, dados_anteriores, dados_novos, ip_address)
    VALUES (NEW.usuario_atualizacao, 'contratos', 'UPDATE', 'contratos', NEW.id, JSON_OBJECT(
        'numero_contrato', OLD.numero_contrato,
        'cliente_id', OLD.cliente_id,
        'titulo', OLD.titulo,
        'valor_total', OLD.valor_total,
        'status', OLD.status
    ), JSON_OBJECT(
        'numero_contrato', NEW.numero_contrato,
        'cliente_id', NEW.cliente_id,
        'titulo', NEW.titulo,
        'valor_total', NEW.valor_total,
        'status', NEW.status
    ), @user_ip);
END//
DELIMITER ;